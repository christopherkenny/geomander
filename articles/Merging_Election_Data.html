<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Merging Election Data • geomander</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/journal/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Merging Election Data">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geomander</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.4.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Merging_Election_Data.html">Merging Election Data</a>
    </li>
    <li>
      <a href="../articles/Redistricting_School_Districts.html">Redistricting School Districts</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/christopherkenny/geomander/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Merging Election Data</h1>
                        <h4 data-toc-skip class="author">Christopher T.
Kenny</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/christopherkenny/geomander/blob/main/vignettes/Merging_Election_Data.Rmd" class="external-link"><code>vignettes/Merging_Election_Data.Rmd</code></a></small>
      <div class="hidden name"><code>Merging_Election_Data.Rmd</code></div>

    </div>

    
    
<p>A common issue in electoral geography is that data needs to be tied
to a spatial component, but the pieces required for an analysis are not
available at the desired levels of geography. This vignette walks
through two common tasks. The first is collecting population data for
precinct-level data, assuming that all (or nearly all) blocks can be
matched to exactly one precinct. The second example is taking
precinct-level data, estimating it down to a block level, and then
aggregating up to voting districts. The second example is useful when
state precincts do not match census voting districts or for when voting
districts or precincts have changed over time.</p>
<p>For most analyses, we want some combination of the below
packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://christophertkenny.com/geomander/">geomander</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/alarm-redist/tinytiger" class="external-link">tinytiger</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="aggregating-population-data-to-precincts">Aggregating Population Data to Precincts<a class="anchor" aria-label="anchor" href="#aggregating-population-data-to-precincts"></a>
</h2>
<p>Many sources of electoral data are focused, as expected, on
elections. As such, many lack the population data that can be necessary
to place racial, turnout, and other population patterns in context.</p>
<p>One of the best sources of electoral data is the <a href="https://dataverse.harvard.edu/dataverse/electionscience" class="external-link">Voting
and Election Science Team</a> for spatial analysis. Using one county
from the Virginia senate election in 2018, this example walks through an
easy way to add population data to this by matching based on the
geographies.</p>
<p>First, we load in the VA county subset included in the package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">va18sub</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">va18sub</span><span class="op">$</span><span class="va">COUNTYFP</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "087"</span></span></code></pre>
<p>After noting the countiy included, we can use create_block_table to
collect the key population boxes needed for most redistricting
analysis.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">block</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_block_table.html">create_block_table</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">'VA'</span>, county <span class="op">=</span> <span class="st">'087'</span>, year <span class="op">=</span> <span class="fl">2010</span><span class="op">)</span>  </span></code></pre></div>
<p>To avoid needing API access, we can use saved data. These polygons
are simplified using <code>rmapshaper</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"va_blocks"</span><span class="op">)</span></span>
<span><span class="va">block</span> <span class="op">&lt;-</span> <span class="va">va_blocks</span></span></code></pre></div>
<p>A typical approach from here is to match the geography from the
blocks to the precincts. In this case, the geographies of the blocks are
expected to match up well with only one precinct match for each block.
This is not necessarily the case for all states or data sources, so
blindly matching can be dangerous. Below, I use the default matching,
which is by st_centerish, which is the centroid of the shape if it is
within the shape or a point on its surface otherwise. There are three
other options that could have been used: - centroid: the center of mass
of the shape - point: a point on the surface of the shape - area: the
intersection that has the largest area (this is most useful when you
expect that boundaries don’t line up well)</p>
<p>Using centroid matching:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geo_match.html">geo_match</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">block</span>, to <span class="op">=</span> <span class="va">va18sub</span>, method <span class="op">=</span> <span class="st">'centroid'</span><span class="op">)</span></span></code></pre></div>
<p>Then we can aggregate this up to the precinct level with
block2prec.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/block2prec.html">block2prec</a></span><span class="op">(</span>block_table <span class="op">=</span> <span class="va">block</span>, matches <span class="op">=</span> <span class="va">matches</span><span class="op">)</span></span></code></pre></div>
<p>An alternative way to do this, especially when the edges of counties
follow natural geographies like rivers, is to use the
block2prec_by_county, which performs the above two steps, but only one
county at a time. It returns the tables joined together. Since there is
only one county in this example, it is unnecessary.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prec_by_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/block2prec_by_county.html">block2prec_by_county</a></span><span class="op">(</span>block_table <span class="op">=</span> <span class="va">block</span>, precinct <span class="op">=</span> <span class="va">va18sub</span>, precinct_county_fips <span class="op">=</span> <span class="st">'COUNTYFP'</span><span class="op">)</span></span></code></pre></div>
<p>In this case, it makes no difference, as the va18sub shapes line up
very well with the block lines.</p>
<p>In either case, the data is arranged by the order of the second
argument (to/precinct), so we can column bind them to have a full
dataset for analysis purposes.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fulldata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">va18sub</span>, <span class="va">prec</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="disaggregating-and-reaggregating">Disaggregating and Reaggregating<a class="anchor" aria-label="anchor" href="#disaggregating-and-reaggregating"></a>
</h2>
<p>A second common task is transferring information from one level of
geography to another. In this case, I use the same Virginia county
subset and blocks, but the end goal is to estimate electoral data in
voting districts from known data in precincts.</p>
<p>The first dataset is the Virginia subset as above:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">va18sub</span><span class="op">)</span></span></code></pre></div>
<p>The second is the block dataset for County 087 (Henrico County).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">block</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_block_table.html">create_block_table</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">'VA'</span>, county <span class="op">=</span> <span class="st">'087'</span><span class="op">)</span>  </span></code></pre></div>
<p>Third, we can use <code>tinytiger</code> to get voting districts for
the relevant Virginia county.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vtd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://alarm-redist.org/tinytiger/reference/tt_voting_districts.html" class="external-link">tt_voting_districts</a></span><span class="op">(</span>state <span class="op">=</span> <span class="st">'VA'</span>, county <span class="op">=</span> <span class="st">'087'</span>, year <span class="op">=</span> <span class="fl">2010</span><span class="op">)</span></span></code></pre></div>
<p>As with other potential calls to the API, this data is also
simplified and included.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"va_vtd"</span><span class="op">)</span></span>
<span><span class="va">vtd</span> <span class="op">&lt;-</span> <span class="va">va_vtd</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vtd</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">va18sub</span>, color <span class="op">=</span> <span class="st">'red'</span>, fill <span class="op">=</span> <span class="st">'NA'</span> <span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Merging_Election_Data_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>Now, an always hopeful bit is that the lines are generally close to
each other, so the final quality of the estimate should be fairly
good.</p>
<p>Next, we need a vector of matches to precinct data (va18sub) from
blocks.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matches_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geo_match.html">geo_match</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">block</span>, to <span class="op">=</span> <span class="va">va18sub</span>, method <span class="op">=</span> <span class="st">'centroid'</span><span class="op">)</span></span></code></pre></div>
<p>And similarly, a vector of matches to voting district data (vtd) from
blocks.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matches_v</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geo_match.html">geo_match</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">block</span>, to <span class="op">=</span> <span class="va">vtd</span>, method <span class="op">=</span> <span class="st">'centroid'</span><span class="op">)</span></span></code></pre></div>
<p>Suppose then that we want to estimate votes for Tim Kaine, weighting
by VAP.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">disagg_kaine</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_down.html">estimate_down</a></span><span class="op">(</span>wts <span class="op">=</span> <span class="va">block</span><span class="op">$</span><span class="va">vap</span>, value <span class="op">=</span> <span class="va">va18sub</span><span class="op">$</span><span class="va">G18USSDKAI</span>, group <span class="op">=</span> <span class="va">matches_p</span><span class="op">)</span></span></code></pre></div>
<p>Then we can reverse this to get to the vtd level:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vtd_kaine</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_up.html">estimate_up</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">disagg_kaine</span>, group <span class="op">=</span> <span class="va">matches_v</span><span class="op">)</span></span></code></pre></div>
<p>Generally, we would want to do this for multiple variables, so I
recommend using geo_match() to identify the matches once, as you can
then apply the estimate_down() and estimate_up() steps to each
variable.</p>
<p>However, in cases where you only need to transfer one variable or you
are more concerned about simplicity than time, the following will
perform those steps:</p>
<p>We estimate down from va18sub to blocks and then up from blocks to
vtd</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">disagg_kaine_geo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geo_estimate_down.html">geo_estimate_down</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">va18sub</span>, to <span class="op">=</span> <span class="va">block</span>, wts <span class="op">=</span> <span class="va">block</span><span class="op">$</span><span class="va">vap</span>, </span>
<span>                                      value <span class="op">=</span> <span class="va">va18sub</span><span class="op">$</span><span class="va">G18USSDKAI</span>, method <span class="op">=</span> <span class="st">'centroid'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vtd_kaine_geo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/geo_estimate_up.html">geo_estimate_up</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">block</span>, to <span class="op">=</span> <span class="va">vtd</span>, value <span class="op">=</span> <span class="va">disagg_kaine_geo</span>, method <span class="op">=</span> </span>
<span>                                   <span class="st">'centroid'</span><span class="op">)</span></span></code></pre></div>
<p>Again, these two methods give the same answers, but the first
approach would allow you to apply the same logic to many variables.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">disagg_kaine</span> <span class="op">==</span> <span class="va">disagg_kaine_geo</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">vtd_kaine</span> <span class="op">==</span> <span class="va">vtd_kaine_geo</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Christopher T. Kenny.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
